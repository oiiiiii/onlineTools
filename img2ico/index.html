<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è½¬ICOå·¥å…· | å¤šå°ºå¯¸æ ‡å‡†ICO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #4F46E5;
            --primary-light: #6366F1;
            --secondary: #10B981;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-700: #374151;
            --gray-900: #111827;
            --white: #FFFFFF;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 8px;
        }

        body {
            background-color: var(--gray-100);
            color: var(--gray-900);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin: 20px auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
        }

        .subtitle {
            color: var(--gray-700);
            font-size: clamp(1rem, 2vw, 1.2rem);
        }

        .upload-section {
            border: 2px dashed var(--gray-200);
            border-radius: var(--radius);
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: border-color 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: var(--primary);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        #file-input {
            display: none;
        }

        .btn {
            display: inline-block;
            background-color: var(--primary);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--radius);
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 0.5rem;
        }

        .btn:hover {
            background-color: var(--primary-light);
        }

        .btn-secondary {
            background-color: var(--secondary);
        }

        .btn-secondary:hover {
            background-color: #059669;
        }

        .preview-section {
            display: none;
            margin: 2rem 0;
        }

        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
        }

        .preview-card {
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .ico-sizes-preview {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .ico-size-item {
            text-align: center;
        }

        .ico-small {
            width: 64px;
            height: 64px;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
        }

        .size-tip {
            color: var(--gray-700);
            font-size: 0.9rem;
            margin-top: 1rem;
            text-align: center;
        }

        .actions {
            text-align: center;
            margin-top: 2rem;
        }

        .footer {
            text-align: center;
            margin-top: 3rem;
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }
            .upload-section {
                padding: 2rem 1rem;
            }
            .preview-container {
                flex-direction: column;
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .btn {
                display: block;
                width: 100%;
                margin: 0.5rem 0;
            }
            .ico-sizes-preview {
                gap: 0.5rem;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loader {
            display: none;
            border: 4px solid var(--gray-200);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å›¾ç‰‡è½¬ICOå·¥å…·</h1>
            <p class="subtitle">æ ‡å‡†å¤šå°ºå¯¸ICO | æœ¬åœ°å¤„ç† | æ— éœ€æœåŠ¡å™¨</p>
        </header>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section" id="upload-area">
            <div class="upload-icon">ğŸ“·</div>
            <h3>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </h3>
            <p>æ”¯æŒ JPG, PNG, WebP, BMP ç­‰æ ¼å¼</p>
            <input type="file" id="file-input" accept="image/*">
            <button class="btn" id="select-file-btn">é€‰æ‹©å›¾ç‰‡</button>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-section" id="preview-section">
            <div class="preview-container">
                <div class="preview-card">
                    <h3>åŸå§‹å›¾ç‰‡</h3>
                    <img id="original-image" class="preview-image" alt="åŸå§‹å›¾ç‰‡">
                </div>
                <div class="preview-card">
                    <h3>å¤šå°ºå¯¸ICOé¢„è§ˆ</h3>
                    <div class="ico-sizes-preview">
                        <div class="ico-size-item">
                            <img id="ico-16" class="ico-small" alt="16x16">
                            <p>16x16</p>
                        </div>
                        <div class="ico-size-item">
                            <img id="ico-32" class="ico-small" alt="32x32">
                            <p>32x32</p>
                        </div>
                        <div class="ico-size-item">
                            <img id="ico-48" class="ico-small" alt="48x48">
                            <p>48x48</p>
                        </div>
                        <div class="ico-size-item">
                            <img id="ico-256" class="ico-small" alt="256x256">
                            <p>256x256</p>
                        </div>
                    </div>
                </div>
            </div>

            <p class="size-tip">ç”Ÿæˆçš„ICOæ–‡ä»¶å°†åŒ…å« 16/32/48/256px å››ç§å°ºå¯¸ï¼Œå…¼å®¹Windows/è½¯ä»¶/ç½‘é¡µæ‰€æœ‰åœºæ™¯</p>

            <!-- åŠ è½½åŠ¨ç”» -->
            <div class="loader" id="loader"></div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="actions">
                <button class="btn btn-secondary" id="convert-btn">ç”Ÿæˆæ ‡å‡†ICO</button>
                <button class="btn" id="download-btn" style="display: none;">ä¸‹è½½ICOæ–‡ä»¶</button>
                <button class="btn" id="reset-btn">é‡æ–°ä¸Šä¼ </button>
            </div>
        </div>

        <div class="footer">
            <p>çº¯å‰ç«¯å®ç° | æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œå›¾ç‰‡ä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ | é€‚é…æ‰€æœ‰è®¾å¤‡</p>
        </div>
    </div>

    <script>
        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const selectFileBtn = document.getElementById('select-file-btn');
        const previewSection = document.getElementById('preview-section');
        const originalImage = document.getElementById('original-image');
        const ico16 = document.getElementById('ico-16');
        const ico32 = document.getElementById('ico-32');
        const ico48 = document.getElementById('ico-48');
        const ico256 = document.getElementById('ico-256');
        const convertBtn = document.getElementById('convert-btn');
        const downloadBtn = document.getElementById('download-btn');
        const resetBtn = document.getElementById('reset-btn');
        const loader = document.getElementById('loader');
        
        // å…¨å±€å˜é‡ï¼šæ ‡å‡†ICOå¿…å¸¦å°ºå¯¸ï¼ˆå…¼å®¹æ‰€æœ‰åœºæ™¯ï¼‰
        const ICO_SIZES = [16, 32, 48, 256];
        let selectedFile = null;
        let icoBlob = null;

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ï¼ˆä¿®å¤é€‰å›¾ä¸¤éBUGï¼‰
        function initEventListeners() {
            // ä¸Šä¼ åŒºåŸŸç‚¹å‡»ï¼šä»…è§¦å‘ä¸€æ¬¡æ–‡ä»¶é€‰æ‹©ï¼Œé˜»æ­¢å†’æ³¡
            uploadArea.addEventListener('click', (e) => {
                if (e.target !== selectFileBtn) { // æ’é™¤æŒ‰é’®ç‚¹å‡»ï¼Œé¿å…é‡å¤
                    fileInput.click();
                }
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            });

            // å•ç‹¬ç»‘å®šé€‰æ‹©æŒ‰é’®ï¼šä»…è§¦å‘ä¸€æ¬¡
            selectFileBtn.addEventListener('click', (e) => {
                fileInput.click();
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡åˆ°ä¸Šä¼ åŒºåŸŸ
            });

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', handleFileSelect);

            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary)';
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = 'var(--gray-200)';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--gray-200)';
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect(e);
                }
            });

            // è½¬æ¢/ä¸‹è½½/é‡ç½®æŒ‰é’®
            convertBtn.addEventListener('click', convertToICO);
            downloadBtn.addEventListener('click', downloadICO);
            resetBtn.addEventListener('click', resetApp);
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }

            selectedFile = file;
            // æ˜¾ç¤ºåŸå§‹å›¾ç‰‡+å„å°ºå¯¸ICOé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImage.src = e.target.result;
                previewSection.style.display = 'block';
                // ç”Ÿæˆå„å°ºå¯¸é¢„è§ˆå›¾
                ICO_SIZES.forEach(size => {
                    generateSizePreview(e.target.result, size);
                });
            };
            reader.readAsDataURL(file);
        }

        // ç”ŸæˆæŒ‡å®šå°ºå¯¸çš„é¢„è§ˆå›¾
        function generateSizePreview(imgSrc, size) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = size;
            canvas.height = size;

            const img = new Image();
            img.onload = () => {
                // ç­‰æ¯”ä¾‹ç¼©æ”¾+å±…ä¸­ç»˜åˆ¶ï¼ˆä¿æŒå›¾ç‰‡æ¯”ä¾‹ï¼Œæ— æ‹‰ä¼¸ï¼‰
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                const x = (canvas.width - img.width * scale) / 2;
                const y = (canvas.height - img.height * scale) / 2;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                // æ›´æ–°å¯¹åº”é¢„è§ˆå›¾
                document.getElementById(`ico-${size}`).src = canvas.toDataURL('image/png');
            };
            img.src = imgSrc;
            img.crossOrigin = 'anonymous';
        }

        // æ ¸å¿ƒï¼šç”Ÿæˆæ ‡å‡†å¤šå°ºå¯¸ICOæ–‡ä»¶ï¼ˆæ‹¼æ¥ICOæ–‡ä»¶å¤´+å„å°ºå¯¸åƒç´ æ•°æ®ï¼‰
        function convertToICO() {
            if (!selectedFile) return;
            loader.style.display = 'block';
            convertBtn.disabled = true;
            downloadBtn.style.display = 'none';

            // å…ˆåŠ è½½åŸå§‹å›¾ç‰‡ï¼Œå†ç”Ÿæˆå„å°ºå¯¸PNGæ•°æ®
            const img = new Image();
            img.onload = async () => {
                try {
                    // è·å–å„å°ºå¯¸çš„PNG Blobæ•°æ®
                    const pngBlobs = await Promise.all(
                        ICO_SIZES.map(size => getPngBlobFromImage(img, size))
                    );
                    // å°†å¤šå°ºå¯¸PNGæ‹¼æ¥ä¸ºæ ‡å‡†ICO Blob
                    icoBlob = await createIcoFromPngBlobs(pngBlobs, ICO_SIZES);
                    
                    loader.style.display = 'none';
                    convertBtn.disabled = false;
                    downloadBtn.style.display = 'inline-block';
                    alert('æ ‡å‡†å¤šå°ºå¯¸ICOç”Ÿæˆå®Œæˆï¼');
                } catch (error) {
                    loader.style.display = 'none';
                    convertBtn.disabled = false;
                    alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
                }
            };
            img.src = originalImage.src;
            img.crossOrigin = 'anonymous';
        }

        // å°†å›¾ç‰‡è½¬ä¸ºæŒ‡å®šå°ºå¯¸çš„PNG Blob
        function getPngBlobFromImage(img, size) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = size;
                canvas.height = size;

                // ç­‰æ¯”ä¾‹ç¼©æ”¾å±…ä¸­
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                const x = (canvas.width - img.width * scale) / 2;
                const y = (canvas.height - img.height * scale) / 2;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

                // è½¬ä¸ºPNG Blob
                canvas.toBlob(resolve, 'image/png');
            });
        }

        // æ ¸å¿ƒï¼šæ‹¼æ¥å¤šå°ºå¯¸PNGä¸ºæ ‡å‡†ICOæ–‡ä»¶ï¼ˆå®ç°ICOæ–‡ä»¶æ ¼å¼è§„èŒƒï¼‰
        function createIcoFromPngBlobs(pngBlobs, sizes) {
            return new Promise(async (resolve) => {
                const icoParts = [];
                const dirEntries = [];
                let offset = 6 + (16 * sizes.length); // ICOæ–‡ä»¶å¤´ + ç›®å½•é¡¹åç§»

                // æ­¥éª¤1ï¼šç”Ÿæˆæ¯ä¸ªPNGçš„ç›®å½•é¡¹+åƒç´ æ•°æ®
                for (let i = 0; i < sizes.length; i++) {
                    const size = sizes[i];
                    const pngBlob = pngBlobs[i];
                    const pngBuffer = await blobToArrayBuffer(pngBlob);
                    const pngLen = pngBuffer.byteLength;

                    // icoç›®å½•é¡¹ï¼ˆ16å­—èŠ‚ï¼‰ï¼šéµå¾ªICOæ ¼å¼è§„èŒƒ
                    const dirEntry = new Uint8Array(16);
                    dirEntry[0] = size === 256 ? 0 : size; // å®½åº¦ï¼ˆ256ä¸º0ï¼‰
                    dirEntry[1] = size === 256 ? 0 : size; // é«˜åº¦ï¼ˆ256ä¸º0ï¼‰
                    dirEntry[2] = 0; // é¢œè‰²æ•°ï¼ˆ0=32ä½ï¼‰
                    dirEntry[3] = 0; // ä¿ç•™ä½
                    dirEntry[4] = 1; // è°ƒè‰²æ¿ï¼ˆ1=æ— ï¼‰
                    dirEntry[5] = 0;
                    dirEntry[6] = 32; // æ¯åƒç´ ä½æ•°
                    dirEntry[7] = 0;
                    const lenView = new DataView(dirEntry.buffer, 8, 4);
                    lenView.setUint32(0, pngLen, true); // æ•°æ®é•¿åº¦
                    const offView = new DataView(dirEntry.buffer, 12, 4);
                    offView.setUint32(0, offset, true); // æ•°æ®åç§»

                    dirEntries.push(dirEntry);
                    icoParts.push(new Uint8Array(pngBuffer));
                    offset += pngLen;
                }

                // æ­¥éª¤2ï¼šç”ŸæˆICOæ–‡ä»¶å¤´ï¼ˆ6å­—èŠ‚ï¼‰
                const header = new Uint8Array(6);
                header[0] = 0; // ä¿ç•™ä½
                header[1] = 0;
                header[2] = 1; // 1=ICOæ–‡ä»¶ï¼Œ2=CURæ–‡ä»¶
                header[3] = 0;
                const countView = new DataView(header.buffer, 4, 2);
                countView.setUint16(0, sizes.length, true); // å›¾åƒæ•°é‡

                // æ­¥éª¤3ï¼šæ‹¼æ¥æ‰€æœ‰éƒ¨åˆ†ï¼ˆå¤´ + ç›®å½•é¡¹ + åƒç´ æ•°æ®ï¼‰
                const allParts = [header, ...dirEntries, ...icoParts];
                const totalLen = allParts.reduce((sum, part) => sum + part.length, 0);
                const icoBuffer = new Uint8Array(totalLen);
                let pos = 0;
                allParts.forEach(part => {
                    icoBuffer.set(part, pos);
                    pos += part.length;
                });

                // è½¬ä¸ºBlob
                resolve(new Blob([icoBuffer], { type: 'image/x-icon' }));
            });
        }

        // Blobè½¬ArrayBuffer
        function blobToArrayBuffer(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsArrayBuffer(blob);
            });
        }

        // ä¸‹è½½ICOæ–‡ä»¶
        function downloadICO() {
            if (!icoBlob) return;
            const url = URL.createObjectURL(icoBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'icon-multi-size.ico'; // å¤šå°ºå¯¸ICOé»˜è®¤æ–‡ä»¶å
            document.body.appendChild(a);
            a.click();
            // æ¸…ç†èµ„æº
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // é‡ç½®åº”ç”¨
        function resetApp() {
            fileInput.value = '';
            selectedFile = null;
            icoBlob = null;
            previewSection.style.display = 'none';
            downloadBtn.style.display = 'none';
            uploadArea.style.borderColor = 'var(--gray-200)';
        }

        // åˆå§‹åŒ–
        initEventListeners();
    </script>
</body>
</html>