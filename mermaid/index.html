<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid 编辑器</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <meta http-equiv="Content-Security-Policy" content="
        script-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net 'sha256-n6tX2bH0aaEToEUtLBZhk1qOzTIrrOi89ZKKsx+aFrQ=' 'sha256-ieoeWczDHkReVBsRBqaal5AFMlBtNjMzgwKvLqi/tSU=';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: blob:;
        connect-src 'self';
        object-src 'none';
        base-uri 'self';
    ">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            color: #333;
        }
        .container {
            display: flex;
            flex-direction: row;
            height: calc(100vh - 60px);
        }
        .editor-wrap {
            flex: 1;
            padding: 10px;
            border-right: 1px solid #eee;
            position: relative;
        }
        .code-editor-container {
            display: flex;
            height: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .line-numbers {
            width: 40px;
            background: #f5f5f5;
            color: #999;
            font-family: Consolas, Monaco, monospace;
            font-size: 16px;
            line-height: 1.5;
            padding: 15px 5px;
            text-align: right;
            user-select: none;
            overflow: hidden;
            white-space: pre;
        }
        #editor {
            flex: 1;
            padding: 15px;
            border: none;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            outline: none;
            font-family: Consolas, Monaco, monospace;
            background: transparent;
            white-space: pre;
        }
        .preview-wrap {
            flex: 1;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        #preview {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        #mermaid-svg {
            max-width: 100%;
            max-height: 100%;
            transition: transform 0.2s ease;
            cursor: grab;
        }
        #mermaid-svg:active {
            cursor: grabbing;
        }
        .toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
            margin: 0 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .save-menu {
            position: relative;
            display: inline-block;
        }
        .save-dropdown {
            display: none;
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            pointer-events: auto;
            min-width: 150px;
        }
        .save-dropdown button {
            display: block;
            width: 100%;
            padding: 10px 20px;
            border: none;
            background: white;
            color: #333;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
        }
        .save-dropdown button:hover {
            background: #f5f5f5;
        }
        @media (max-width: 767px) {
            .container {
                flex-direction: column;
            }
            .editor-wrap, .preview-wrap {
                flex: none;
                height: 50%;
            }
            .editor-wrap {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            .toolbar {
                height: auto;
                padding: 10px;
            }
            .btn {
                padding: 8px 15px;
                font-size: 14px;
                margin: 5px;
            }
            .save-dropdown {
                bottom: 60px;
                left: 0;
                transform: none;
            }
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="editor-wrap">
            <div class="code-editor-container">
                <div class="line-numbers" id="lineNumbers"></div>
                <textarea id="editor">graph TD
    A[开始] --> B{选择技术栈}
    B -->|Python| C[FastAPI]
    B -->|前端| D[Mermaid.js]
    C --> E[本地运行]
    D --> F[响应式布局]
    E --> G[部署到Cloudflare]
    F --> G
    G --> H[完成]</textarea>
            </div>
        </div>
        <div class="preview-wrap">
            <div id="preview">
                <div class="loading">初始化渲染引擎...</div>
            </div>
        </div>
    </div>

    <div class="toolbar">
        <button class="btn" id="render-btn">重新渲染</button>
        <div class="save-menu">
            <button class="btn" id="save-main-btn">保存文件 ▼</button>
            <div class="save-dropdown" id="save-dropdown">
                <button id="save-txt">保存为 TXT</button>
                <button id="save-png">保存为 PNG</button>
                <button id="save-svg">保存为 SVG</button>
            </div>
        </div>
        <button class="btn" id="load-btn">加载文件</button>
        <button class="btn btn-secondary" id="reset-btn">重置视图</button>
    </div>

    <script>
        // 全局变量
        let mermaidLoaded = false;
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let startX, startY;

        // DOM元素
        const editor = document.getElementById('editor');
        const lineNumbers = document.getElementById('lineNumbers');
        const preview = document.getElementById('preview');
        const renderBtn = document.getElementById('render-btn');
        const loadBtn = document.getElementById('load-btn');
        const resetBtn = document.getElementById('reset-btn');
        const saveTxtBtn = document.getElementById('save-txt');
        const savePngBtn = document.getElementById('save-png');
        const saveSvgBtn = document.getElementById('save-svg');
        const svgContainer = document.createElement('div');
        svgContainer.id = 'mermaid-svg';
        const saveMainBtn = document.getElementById('save-main-btn');
        const saveDropdown = document.getElementById('save-dropdown');

        // ========== 核心优化：优先加载 Mermaid（页面加载时就初始化） ==========
        async function loadMermaid() {
            if (mermaidLoaded) return;
            preview.innerHTML = '<div class="loading">加载渲染引擎中...</div>';
            
            // 定义多个备用 CDN 地址（提高加载成功率）
            const cdnUrls = [
                'https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js', // Cloudflare CDN（优先）
                'https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js'      // 备用 CDN
            ];

            let loadError = null;
            // 依次尝试加载 CDN，直到成功
            for (const url of cdnUrls) {
                try {
                    const script = document.createElement('script');
                    script.src = url;
                    script.async = false; // 同步加载，确保顺序

                    await new Promise((resolve, reject) => {
                        script.onload = resolve;
                        script.onerror = () => reject(new Error(`CDN加载失败: ${url}`));
                        document.head.appendChild(script);
                    });

                    // 初始化 Mermaid
                    mermaid.initialize({
                        startOnLoad: false,
                        theme: 'default',
                        securityLevel: 'loose',
                        flowchart: { useMaxWidth: false }
                    });
                    mermaidLoaded = true;
                    loadError = null;
                    break; // 加载成功，退出循环
                } catch (err) {
                    loadError = err;
                    console.warn(`尝试 ${url} 失败:`, err.message);
                }
            }

            if (loadError) {
                throw loadError;
            }
        }

        // ========== 行号更新 ==========
        function updateLineNumbers() {
            const cleanValue = editor.value.replace(/^\s+|\s+$/g, '');
            const lines = cleanValue.split('\n');
            const lineCount = lines.length;
            let lineNumbersHtml = '';
            for (let i = 1; i <= lineCount; i++) {
                lineNumbersHtml += `${i}\n`;
            }
            lineNumbers.textContent = lineNumbersHtml;
            lineNumbers.scrollTop = editor.scrollTop;
        }

        // ========== 渲染函数 ==========
        async function renderMermaid() {
            try {
                if (!mermaidLoaded) {
                    await loadMermaid(); // 兜底：如果初始化失败，渲染时重试
                }

                preview.innerHTML = '<div class="loading">渲染中...</div>';
                const code = editor.value.trim();
                if (!code) {
                    preview.innerHTML = '<div class="loading">请输入Mermaid代码</div>';
                    return;
                }

                const renderPromise = mermaid.render('mermaid-chart', code);
                const { svg } = await Promise.race([
                    renderPromise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error("渲染超时（5秒）")), 5000))
                ]);

                svgContainer.innerHTML = svg;
                svgContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
                preview.innerHTML = '';
                preview.appendChild(svgContainer);
            } catch (error) {
                preview.innerHTML = `<div style="color: red; padding: 20px; text-align: left; font-size: 14px;">
                    <strong>操作失败：</strong><br>${error.message}<br>
                    <small>建议：1. 刷新页面 2. 检查网络 3. 更换浏览器</small>
                </div>`;
                console.error('详情:', error);
            }
        }

        // ========== 保存功能 ==========
        function saveAsTxt() {
            const code = editor.value;
            const blob = new Blob([code], { type: 'text/plain' });
            downloadFile(blob, 'mermaid-diagram.txt');
            saveDropdown.style.display = 'none';
        }

        function saveAsSvg() {
            const svgElement = svgContainer.querySelector('svg');
            if (!svgElement) {
                alert('暂无可保存的SVG图表，请先渲染图表');
                return;
            }
            const clone = svgElement.cloneNode(true);
            const svgData = new XMLSerializer().serializeToString(clone);
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            downloadFile(blob, 'mermaid-diagram.svg');
            saveDropdown.style.display = 'none';
        }

        async function saveAsPng() {
            const svgElement = svgContainer.querySelector('svg');
            if (!svgElement) {
                alert('暂无可保存的PNG图表，请先渲染图表');
                return;
            }

            try {
                const svgData = new XMLSerializer().serializeToString(svgElement);
                const img = new Image();
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml' });
                const svgUrl = URL.createObjectURL(svgBlob);

                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = svgElement.viewBox.baseVal.width || img.width;
                    canvas.height = svgElement.viewBox.baseVal.height || img.height;
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob(blob => {
                        downloadFile(blob, 'mermaid-diagram.png');
                        URL.revokeObjectURL(svgUrl);
                        saveDropdown.style.display = 'none';
                    }, 'image/png');
                };
                img.src = svgUrl;
            } catch (error) {
                alert(`保存PNG失败：${error.message}`);
                console.error('PNG保存失败:', error);
                saveDropdown.style.display = 'none';
            }
        }

        function downloadFile(blob, filename) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        // ========== 加载文件 ==========
        function loadFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.mmd,.mermaid';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    editor.value = event.target.result;
                    updateLineNumbers();
                    renderMermaid();
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ========== 重置视图 ==========
        function resetView() {
            scale = 1;
            translateX = 0;
            translateY = 0;
            svgContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        }

        // ========== 手势/拖动 ==========
        function initGesture() {
            let lastDistance = 0;

            svgContainer.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (e.touches.length === 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX - translateX;
                    startY = e.touches[0].clientY - translateY;
                } else if (e.touches.length === 2) {
                    lastDistance = getDistance(e.touches[0], e.touches[1]);
                }
            });

            svgContainer.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 1 && isDragging) {
                    translateX = e.touches[0].clientX - startX;
                    translateY = e.touches[0].clientY - startY;
                    svgContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
                } else if (e.touches.length === 2) {
                    const newDistance = getDistance(e.touches[0], e.touches[1]);
                    const delta = newDistance - lastDistance;
                    scale += delta * 0.001;
                    scale = Math.max(0.5, Math.min(scale, 3));
                    lastDistance = newDistance;
                    svgContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
                }
            });

            svgContainer.addEventListener('touchend', () => {
                isDragging = false;
            });

            function getDistance(touch1, touch2) {
                const dx = touch2.clientX - touch1.clientX;
                const dy = touch2.clientY - touch1.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        }

        function initDesktopDrag() {
            // 修复原代码笔误：startY = e.clientY - startY → startY = e.clientY - translateY
            svgContainer.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    translateX = e.clientX - startX;
                    translateY = e.clientY - startY;
                    svgContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            svgContainer.addEventListener('wheel', (e) => {
                e.preventDefault();
                scale += e.deltaY * -0.001;
                scale = Math.max(0.5, Math.min(scale, 3));
                svgContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            });
        }

        // ========== 保存菜单 ==========
        function toggleSaveDropdown() {
            saveDropdown.style.display = saveDropdown.style.display === 'block' ? 'none' : 'block';
        }

        saveMainBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSaveDropdown();
        });

        saveDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        document.addEventListener('click', () => {
            saveDropdown.style.display = 'none';
        });

        // ========== 事件绑定 & 初始化 ==========
        // 初始化行号
        updateLineNumbers();
        editor.addEventListener('input', updateLineNumbers);
        editor.addEventListener('scroll', () => {
            lineNumbers.scrollTop = editor.scrollTop;
        });

        // 绑定按钮事件
        renderBtn.addEventListener('click', renderMermaid);
        loadBtn.addEventListener('click', loadFile);
        resetBtn.addEventListener('click', resetView);
        saveTxtBtn.addEventListener('click', saveAsTxt);
        saveSvgBtn.addEventListener('click', saveAsSvg);
        savePngBtn.addEventListener('click', saveAsPng);

        // 页面加载时立即初始化 Mermaid + 渲染
        window.addEventListener('load', async () => {
            await loadMermaid().catch(err => {
                preview.innerHTML = `<div style="color: red; padding: 20px; text-align: left; font-size: 14px;">
                    <strong>渲染引擎加载失败：</strong><br>${err.message}<br>
                    <small>所有备用CDN均加载失败，请检查网络或稍后重试</small>
                </div>`;
            });
            await renderMermaid();
            
            // 初始化手势/拖动
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                initGesture();
            } else {
                initDesktopDrag();
            }
        });

        // 窗口大小变化重新渲染
        window.addEventListener('resize', renderMermaid);
    </script>
</body>
</html>